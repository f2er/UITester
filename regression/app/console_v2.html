<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>UITester Console</title>
    <script src="/socket.io/socket.io.js"></script>
    <script charset="utf-8" src="http://assets.daily.taobao.net/p/uitest/build/uitest.js"></script>
</head>
<body>
<h3>UITester 运行控制台</h3>

<div class="alert alert-info">
    <h3>安装：</h3>

    <p> 1.安装UITester浏览器插件<a href="http://assets.daily.taobao.net/p/uitest/plugin/chrome/src.rar">chrome</a>
        <a href="http://assets.daily.taobao.net/p/uitest/plugin/ie/setup/setup.rar">ie</a>
    </p>

    <p>2.设置浏览器允许窗口打开</p>

    <p>3.点击开始按钮
        <button id="start">开始</button>
    </p>

</div>
<br>
<br>

<div class="alert alert-info">
    <p id="info" style="color: red"></p>

    <p style="color: red" id="browser_info"></p>

    <p style="color: red" id="test_number"></p>
</div>


<script>
    (function () {
        try {


            var isConnected = false;
            var http_host = location.host;

            var socket;

            var test_number = 0;
           var test_timeout_number =0;
            var init = false;
            var isRunning = false;
            if (!window.console) {
                window.console = {
                    log:function () {
                    },
                    info:function () {
                    },
                    debug:function () {
                    }
                }
            }


            if (socket) {
                jQuery("#info").html("链接已经建立");
                return;
            }
            jQuery("#info").html("正在建议链接");
            socket = io.connect('http://' + http_host);

            socket.on("connect", function () {
                isConnected = true;

                if (init) {
                    socket.emit('console:register', {
                        'userAgent':window.navigator.userAgent
                    });
                    jQuery("#info").html("链接重新建立成功");
                    console.log("链接重新建立成功");
                    return;
                }
                else {
                    jQuery("#info").html("链接建立成功");
                    console.log("链接建立成功")
                }


                jQuery("#info").html("正在打开运行窗口");


                var test_run_win = window.open("about:blank", "", 'height=10, width=20,  left=0 ,  top=0,location=yes, toolbar=no,resizable=yes, menubar=no, status=no')
                var id = 'jasmine_run_id_' + (Math.random() * (1 << 30)).toString(16).replace('.', '');
                test_run_win.location.href = 'http://' + http_host + "/run_test.html?id=" + id;


                if (test_run_win) {

                    jQuery("#info").html("打开运行窗口成功");

                }
                else {
                    jQuery("#info").html("打开运行窗口失败");
                    return;
                }
                jQuery("#info").html("测试脚本注入...");

                UT._msgReady(test_run_win,
                        function () {
                            test_run_win.close();
                            jQuery("#info").html("脚本注入成功");
                            socket.emit('console:register', {
                                'userAgent':window.navigator.userAgent
                            });
                            socket.on('disconnect', function () {
                                isConnected = false;
                                jQuery("#info").html("失去链接" + new Date().getTime());
                                console.log("失去链接" + new Date().getTime())


                            });
                            socket.on('console:reload', function (data) {
                                window.location.reload();

                            });
                            socket.on('console:update', function (data) {
                                jQuery("#browser_info").html("当前浏览器信息: " + JSON.stringify(data));

                            });


                            socket.on('console:task_start', function (data) {
                                if (isRunning)return;

                                isRunning = data.id;

                                var timeout;

                                jQuery("#info").html("任务开始 " + "id:" + data.id + " url:" + data.url);
                                console.log(data.id + "任务开始");

                                if (data && data.url) {
                                    //创建一个独立的环境
                                    jasmine._newEnv = true;
                                    UT.configs.autoClose = true;
                                    window.alert = function () {
                                    };
                                    UT.configs.windowType = "window";

                                    UT._setForceClose(true);
                                    var url = $.trim(data.url);
                                    if (url.indexOf("?") != -1) {
                                        url = url + "&t=" + new Date().getTime();
                                    }
                                    else {
                                        url = url + "?t=" + new Date().getTime();
                                    }
                                    try {
                                        var isloading = true;
                                        jQuery.getScript(url, function () {
                                            isloading = false;
                                            if (timeout) {
                                                window.clearTimeout(timeout);
                                                timeout = null;
                                            }
                                            UT.execute(function (report) {
                                                isRunning = false;
                                                test_number++;
                                                jQuery("#test_number").html(test_number);
                                                jQuery("#info").html("任务完成" + "id:" + data.id + " url:" + data.url);
                                                console.log(data.id + "任务完成");
                                                socket.emit('console:task_finish', {id:data.id, report:report});
                                            })
                                        })
                                    } catch (e) {
                                        var report = UT.defaultResult;
                                        report.reports.errors.push({
                                            message:e.message
                                        })
                                        socket.emit('console:task_finish', {id:data.id, report:report});
                                    }
                                    timeout = window.setTimeout(function () {
                                        if (!isloading)return;
                                        isloading = true;
                                        isRunning = false;

                                        var report = UT.defaultResult;
                                        report.reports.errors.push({
                                            message:url + "加载失败"
                                        })
                                        socket.emit('console:task_finish', {id:data.id, report:report});


                                    }, 1000 * 10);


                                }


                            });

                            init = true;
                            jQuery("#info").html("启动完成，等待任务中...");


                        },
                        function () {
                            jQuery("#info").html("脚本注入失败");
                        }
                );


            })


            $("#start").bind("click", function () {
                window.location.reload();
            });


        } catch (e) {
            // if (run_win && run_win.close)run_win.close();
            window.location.reload();
        }
    })();
</script>

</body>
</html>
