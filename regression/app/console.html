<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>UITester Console</title>
</head>
<body>
<div id="info"></div>
<div class="alert alert-info" style="margin: 10px auto;padding:8px;text-align: left;width: 500px; ">
    <strong>测试方式</strong>
    <p> 1.安装UITester浏览器插件<a href="http://assets.daily.taobao.net/p/uitest/plugin/chrome/src.crx">chrome</a>
        <a href="http://assets.daily.taobao.net/p/uitest/plugin/ie/ie_plugin/IESetup/Debug/IESetup.msi">ie</a>
    </p>
    <p>2.设置浏览器允许窗口打开</p>

</div>


<script charset="utf-8" src="http://assets.daily.taobao.net/p/uitest/build/uitest.js"></script>
<script src="/socket.io/socket.io.js"></script>

<script>
    (function () {
        UT.configs.windowType = "window";
        var timer = null;
        var isRunning = false;
        var isConnected = false
        var http_host = location.host;
        var socket = io.connect('http://' + http_host);

        if (!window.console) {
            window.console = {
                log:function () {
                },
                info:function () {
                },
                debug:function () {
                }
            }
        }
        socket.on("connect", function () {
            console.info("connect");
            socket.emit('console:register', {
                'userAgent':window.navigator.userAgent
            });
            if (isConnected) return;
            isConnected = true;


            socket.on('console:reload', function (data) {
                window.location.reload();

            });

            // Get Client Summary
            socket.on('console:summary', function (data) {
                jQuery("#info").html(JSON.stringify(data));
            });


            // when task data push by socket, this event
            // will be triggered
            var callback = {};
            var runWindow;
            socket.on('console:task_start', function (data) {
                console.log("console:task_start", data);

                var isRunning = true;
                var id = 'jasmine_run_id_' + (Math.random() * (1 << 30)).toString(16).replace('.', '');
                var win;
                if (timer) {
                    window.clearTimeout(timer);
                    timer = null;
                }
                timer = setTimeout(function () {
                    // 三分钟没有完成，
                    var defaultResult = UT.defaultResult;
                    defaultResult.errors.push({
                        message:"超时"
                    })
                    if (callback[id]) {
                        callback[id](defaultResult)
                    }
                }, 1000 * 60 * 5)

                if (data && data.task_inject_uri) {
                    //创建一个独立的环境
                    var win = window.open("about:blank", "", 'height=400, width=600, top=100 , left=100 , toolbar=no, menubar=no, status=no')
                    win.location.href = "run.html?url=" + encodeURIComponent(data.task_inject_uri) + "&id=" + id;
                    callback[id] = function (data) {
                        console.log("result",data)
                        socket.emit('console:task_finish', data);
                        win.close();
                    }
                }


            });

            //等结果
            UT.postmsg.bind(function (data) {
                if (data.id && callback[data.id]) {
                    console.log("收到结果")
                    callback[data.id](data.report);
                    delete callback[data.id];
                }


            })

        })


        var runScriptFromUrl = function (url, callback) {


        };


    })();
</script>

</body>
</html>
