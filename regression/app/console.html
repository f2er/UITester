<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>UITester Console</title>
    <script src="/socket.io/socket.io.js"></script>
    <script charset="utf-8" src="http://assets.daily.taobao.net/p/uitest/build/uitest.js"></script>
</head>
<body>
<h3>UITester 运行控制台</h3>

<div class="alert alert-info">
    <h3>安装：</h3>

    <p> 1.安装UITester浏览器插件<a href="http://assets.daily.taobao.net/p/uitest/plugin/chrome/src.rar">chrome</a>
        <a href="http://assets.daily.taobao.net/p/uitest/plugin/ie/ie_plugin/setup/setup.rar">ie</a>
    </p>

    <p>2.设置浏览器允许窗口打开</p>

    <p>3.点击开始按钮
        <button id="start">开始</button>
    </p>

</div>
<br>
<br>

<div class="alert alert-info">
    <p id="info" style="color: red"></p>

    <p style="color: red" id="browser_info"></p>

    <p style="color: red" id="test_number"></p>
</div>


<script>


    var isRunning = false;
    var isConnected = false
    var http_host = location.host;
    var run_timer;
    var socket;
    var run_win;
    var test_number = 0;
    var callback =[];
    if (!window.console) {
        window.console = {
            log:function () {
            },
            info:function () {
            },
            debug:function () {
            }
        }
    }
    var testTimer;
    var test_n = 0;

    var start = function () {
        if (socket) {
            jQuery("#info").html("链接已经建立");
            return;
        }
        jQuery("#info").html("正在建议链接");
        socket = io.connect('http://' + http_host);


        socket.on("connect", function () {
            if (run_win && run_win.close)run_win.close();
            jQuery("#info").html("链接建立成功");


            jQuery("#info").html("正在打开运行窗口");


            var test_run_win = window.open("about:blank", "", 'height=10, width=10,  left=0 ,  top=0,location=yes, toolbar=no,resizable=yes, menubar=no, status=no')
            var id = 'jasmine_run_id_' + (Math.random() * (1 << 30)).toString(16).replace('.', '');
            test_run_win.location.href = 'http://' + http_host + "/run.html?id=" + id;


            if (test_run_win) {

                jQuery("#info").html("打开运行窗口成功");

            }
            else {
                jQuery("#info").html("打开运行窗口失败");
                return;
            }
            jQuery("#info").html("测试脚本注入...");

            UT._msgReady(test_run_win,
                    function () {
                        test_run_win.close();
                        jQuery("#info").html("脚本注入成功");
                        socket.emit('console:register', {
                            'userAgent':window.navigator.userAgent
                        });
                        socket.on('disconnect', function () {
                            jQuery("#info").html("失去连接，5秒后重新链接")
                            setTimeout(function () {
                                window.location.reload();
                            }, 5000)
                        });
                        socket.on('console:reload', function (data) {
                            window.location.reload();

                        });
                        socket.on('console:summary', function (data) {
                            jQuery("#browser_info").html("当前浏览器信息: " + JSON.stringify(data));
                        });


                        socket.on('console:task_start', function (data) {
                            if (data && data.task_inject_uri) {
                                //创建一个独立的环境
                                var runing = true;
                                jQuery("#info").html("任务开始 " + "id:" + data.id + " url:" + data.task_inject_uri);
                                if (!run_win) {
                                    run_win = window.open("about:blank", "", 'height=600, width=800,  left=300 ,  top=100,location=yes, toolbar=no,resizable=yes, menubar=no, status=no')
                                }


                                var id = 'jasmine_run_id_' + (Math.random() * (1 << 30)).toString(16).replace('.', '');
                                run_win.location.href = 'http://' + http_host + "/run.html?url=" + encodeURIComponent(data.task_inject_uri) + "&id=" + id;
                                callback[id] = function (data) {
                                    jQuery("#info").html("任务完成");
                                    runing = false;
                                    if(run_timer){
                                        window.clearTimeout(run_timer);
                                        run_timer = null;
                                    }
                                    socket.emit('console:task_finish', data);

                                }


                                run_timer = setTimeout(function () {
                                    // 三分钟没有完成，
                                    if(!runing) return;
                                    var defaultResult = UT.defaultResult;
                                    defaultResult.reports.errors.push({
                                        message:"超时"
                                    })
                                    socket.emit('console:task_finish', defaultResult);

                                }, 1000 * 60 * 10)
                            }


                        });
                        jQuery("#info").html("启动完成，等待任务中...");


                    },
                    function () {
                        jQuery("#info").html("脚本注入失败");
                    }
            );


        })


    };

    start();
    //等结果
    UT.postmsg.bind(function (data) {
        if (data.id && callback[data.id]) {
            callback[data.id](data.report);
            delete callback[data.id];
        }


    })

    $("#start").on("click", function () {
        window.location.reload();
    });
    jQuery(window).on("beforeunload", function (e) {
        if (run_win && run_win.close)run_win.close();
    })


</script>

</body>
</html>
