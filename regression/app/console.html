<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>UITester Console</title>
</head>
<body>
<div id="info"></div>
<h3>请先安装浏览器插件</h3>
<ul>
    <li><a href="http://assets.daily.taobao.net/p/uitest/plugin/chrome/src.crx">chrome</a></li>
    <li><a href="http://assets.daily.taobao.net/p/uitest/plugin/ie/ie_plugin/IESetup/Debug/IESetup.msi">ie</a></li>
</ul>


<script charset="utf-8" src="http://assets.daily.taobao.net/p/uitest/build/uitest.js"></script>
<script src="/socket.io/socket.io.js"></script>

<script>
    (function () {
        var timer = null;
        var isRunning = false;
        var isConnected = false
        var http_host = location.host;
        var socket = io.connect('http://' + http_host);

        if (!window.console) {
            window.console = {
                log:function () {
                },
                info:function () {
                },
                debug:function () {
                }
            }
        }
        socket.on("connect", function () {
            console.info("connect");
            socket.emit('console:register', {
                'userAgent':window.navigator.userAgent
            });
            if (isConnected) return;
            isConnected = true;


            socket.on('console:reload', function (data) {
                window.location.reload();

            });

            // Get Client Summary
            socket.on('console:summary', function (data) {
                jQuery("#info").html(JSON.stringify(data));
            });


            // when task data push by socket, this event
            // will be triggered
            var callback = {};
            var runWindow;
            socket.on('console:task_start', function (data) {
                console.log("console:task_start", data);

                var isRunning = true;
                var id = 'jasmine_run_id_' + (Math.random() * (1 << 30)).toString(16).replace('.', '');
                var win;
                if (timer) {
                    window.clearTimeout(timer);
                    timer = null;
                }
                timer = setTimeout(function () {
                    // 三分钟没有完成，
                    if (callback[id]) {
                        callback[id]({reports:{total_specs:0, failed_specs:0,suites:{}}})
                    }
                }, 1000 * 60 * 2)

                if (data && data.task_inject_uri) {
                    //创建一个独立的环境
                    var win = window.open("about:blank", "", 'height=400, width=600, top=100 , left=100 , toolbar=no, menubar=no, status=no')
                    win.location.href = "run.html?url=" + encodeURIComponent(data.task_inject_uri) + "&id=" + id;
                    callback[id] = function (data) {
                        socket.emit('console:task_finish', data);
                        win.close();
                    }
                }


            });

            //等结果
            UT.postmsg.bind(function (data) {
                if (data.id && callback[data.id]) {
                    console.log("收到结果")
                    callback[data.id](data.report);
                    delete callback[data.id];
                }


            })

        })


        var runScriptFromUrl = function (url, callback) {


        };


    })();
</script>

</body>
</html>
